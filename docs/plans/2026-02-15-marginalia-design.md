# Marginalia AI Chat Plugin - è®¾è®¡æ–‡æ¡£

**é¡¹ç›®åç§°**: Marginalia AI Chat
**æ—¥æœŸ**: 2026-02-15
**çŠ¶æ€**: è®¾è®¡å·²æ‰¹å‡†

---

## 1. é¡¹ç›®æ¦‚è¿°

Marginalia æ˜¯ä¸€ä¸ª Zotero 7 æ’ä»¶ï¼Œå…è®¸ç”¨æˆ·åœ¨é˜…è¯»è®ºæ–‡æ—¶ï¼Œé€šè¿‡ä¾§è¾¹æ ä¸ AI è¿›è¡Œå®æ—¶å¯¹è¯ï¼ŒåŸºäºå½“å‰è®ºæ–‡è¿›è¡Œé—®ç­”å’Œåˆ†æã€‚

### æ ¸å¿ƒç‰¹æ€§
- ä¾§è¾¹æ å¯¹è¯æ¡†ï¼ˆä¸æ‰“æ‰°é˜…è¯»ä½“éªŒï¼‰
- æ”¯æŒ OpenAI å…¼å®¹çš„ APIï¼ˆè‡ªå®šä¹‰ URL å’Œ API Keyï¼‰
- æŒ‰æ–‡çŒ®ä¿å­˜å¯¹è¯å†å²
- å·¥å…·è°ƒç”¨åŠŸèƒ½ï¼ˆAI å¯è®¿é—®å…¶ä»–è®ºæ–‡ä¿¡æ¯ï¼‰
- å¯¹è¯ç®¡ç†ï¼ˆæ¸…é™¤å†å²ã€å¯¼å‡ºä¸º Markdownã€å¤åˆ¶æ¶ˆæ¯ï¼‰
- ç¾è§‚ç®€æ´çš„ UI è®¾è®¡

---

## 2. æ•´ä½“æ¶æ„

### 2.1 ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Zotero 7 ä¸»çª—å£                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Item Pane (å³ä¾§ä¾§è¾¹æ )                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ [æ ‡ç­¾é¡µ] [æ ‡ç­¾é¡µ] [AI Chat] â—„â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚                                   â”‚  â”‚
â”‚  â”‚  å¯¹è¯æ¡†åŒºåŸŸ                        â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ AI: ä½ å¥½ï¼Œæˆ‘æ˜¯ Marginalia... â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                             â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ User: è¿™ç¯‡è®ºæ–‡è®²ä»€ä¹ˆï¼Ÿ      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ AI: è¿™ç¯‡è®ºæ–‡ä¸»è¦è®¨è®º...     â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                   â”‚  â”‚
â”‚  â”‚  è¾“å…¥æ¡† + æŒ‰é’®åŒºåŸŸ                 â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ [è¾“å…¥æ¡†] [å‘é€] [+é€‰é¡¹]     â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ ¸å¿ƒç»„ä»¶

| ç»„ä»¶ | èŒè´£ | æŠ€æœ¯æ ˆ |
|------|------|--------|
| **ChatPanel** | ä¾§è¾¹æ å¯¹è¯æ¡†ä¸»ç»„ä»¶ | TypeScript + HTML/CSS |
| **MessageList** | æ¶ˆæ¯åˆ—è¡¨å±•ç¤º | React-like ç»„ä»¶ |
| **InputBox** | è¾“å…¥æ¡† + å‘é€æŒ‰é’® | HTML/CSS |
| **OptionsMenu** | åº•éƒ¨"+"é€‰é¡¹èœå• | ä¸‹æ‹‰èœå• |
| **SettingsPanel** | è®¾ç½®é¡µé¢ | Zotero åå¥½è®¾ç½® UI |
| **APIClient** | OpenAI å…¼å®¹ API è°ƒç”¨ | TypeScript |
| **ToolCaller** | å·¥å…·è°ƒç”¨æ‰§è¡Œå™¨ | TypeScript |
| **StorageManager** | æ•°æ®åº“æ“ä½œ | Zotero SQLite |

---

## 3. æ•°æ®å­˜å‚¨ç»“æ„

### 3.1 æ•°æ®åº“è¡¨è®¾è®¡

#### è¡¨ 1: marginalia_conversations
```sql
CREATE TABLE marginalia_conversations (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  itemID INTEGER NOT NULL,           -- Zotero Item ID
  role TEXT NOT NULL,                -- 'user' æˆ– 'assistant'
  content TEXT NOT NULL,             -- æ¶ˆæ¯å†…å®¹
  timestamp INTEGER NOT NULL,        -- Unix æ—¶é—´æˆ³
  toolCalls JSON,                    -- å·¥å…·è°ƒç”¨ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
  FOREIGN KEY (itemID) REFERENCES items(itemID)
);
```

#### è¡¨ 2: marginalia_settings
```sql
CREATE TABLE marginalia_settings (
  key TEXT PRIMARY KEY,
  value TEXT NOT NULL
);
```

### 3.2 å­˜å‚¨çš„è®¾ç½®é¡¹

| è®¾ç½®é¡¹ | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| `apiUrl` | string | OpenAI å…¼å®¹çš„ API åœ°å€ |
| `apiKey` | string | API å¯†é’¥ï¼ˆåŠ å¯†å­˜å‚¨ï¼‰ |
| `model` | string | ä½¿ç”¨çš„æ¨¡å‹åç§°ï¼ˆå¦‚ gpt-4o-miniï¼‰ |
| `maxHistoryRounds` | number | ä¿å­˜çš„æœ€å¤§å¯¹è¯è½®æ•°ï¼ˆé»˜è®¤ 20ï¼‰ |
| `enableToolCalling` | boolean | æ˜¯å¦å¯ç”¨å·¥å…·è°ƒç”¨ |
| `systemPrompt` | string | ç³»ç»Ÿæç¤ºè¯ |

---

## 4. å·¥å…·è°ƒç”¨æ¡†æ¶

### 4.1 å¯ç”¨å·¥å…·å®šä¹‰

```typescript
const tools = [
  {
    name: "get_paper_info",
    description: "è·å–æŒ‡å®šè®ºæ–‡çš„åŸºæœ¬ä¿¡æ¯ï¼ˆæ ‡é¢˜ã€ä½œè€…ã€æ‘˜è¦ç­‰ï¼‰",
    parameters: {
      itemID: "number",  // Zotero Item ID
    }
  },
  {
    name: "get_paper_content",
    description: "è·å–æŒ‡å®šè®ºæ–‡çš„å…¨æ–‡å†…å®¹ï¼ˆé€šè¿‡ Zotero.FullText APIï¼‰",
    parameters: {
      itemID: "number",
    }
  },
  {
    name: "search_papers",
    description: "åœ¨å½“å‰åº“ä¸­æœç´¢ç›¸å…³è®ºæ–‡",
    parameters: {
      query: "string",
      limit: "number"  // æœ€å¤šè¿”å›å¤šå°‘ç¯‡
    }
  }
];
```

### 4.2 å·¥å…·è°ƒç”¨æµç¨‹

1. ç”¨æˆ·å¯ç”¨"å·¥å…·è°ƒç”¨"å¼€å…³
2. AI åœ¨å›å¤ä¸­åŒ…å«å·¥å…·è°ƒç”¨è¯·æ±‚ï¼ˆJSON æ ¼å¼ï¼‰
3. æ’ä»¶è§£æå·¥å…·è°ƒç”¨ï¼Œè°ƒç”¨ç›¸åº”çš„ Zotero API
4. å°†ç»“æœè¿”å›ç»™ AIï¼ŒAI ç»§ç»­å¯¹è¯
5. å¯¹è¯å®Œæˆï¼Œè‡ªåŠ¨ä¿å­˜åˆ°æ•°æ®åº“

### 4.3 å®‰å…¨è€ƒè™‘

- å·¥å…·è°ƒç”¨åªæš´éœ²å¿…è¦çš„ APIï¼ˆä¸å…è®¸åˆ é™¤æˆ–ä¿®æ”¹è®ºæ–‡ï¼‰
- ç”¨æˆ·å¯ä»¥æ‰‹åŠ¨å¯ç”¨/ç¦ç”¨å·¥å…·è°ƒç”¨åŠŸèƒ½
- å·¥å…·è°ƒç”¨ç»“æœä¼šè¢«è®°å½•åœ¨å¯¹è¯å†å²ä¸­

---

## 5. è®¾ç½®é¡µé¢è®¾è®¡

### 5.1 è®¾ç½®é¡µé¢å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Marginalia AI Chat è®¾ç½®                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  API é…ç½®                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ API URL:                        â”‚   â”‚
â”‚  â”‚ [https://api.openai.com/v1]     â”‚   â”‚
â”‚  â”‚                                 â”‚   â”‚
â”‚  â”‚ API Key:                        â”‚   â”‚
â”‚  â”‚ [â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢]          â”‚   â”‚
â”‚  â”‚                                 â”‚   â”‚
â”‚  â”‚ Model:                          â”‚   â”‚
â”‚  â”‚ [gpt-4o-mini â–¼]                â”‚   â”‚
â”‚  â”‚                                 â”‚   â”‚
â”‚  â”‚ [æµ‹è¯•è¿æ¥] [ä¿å­˜]               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚
â”‚  å¯¹è¯è®¾ç½®                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ æœ€å¤§ä¿å­˜å¯¹è¯è½®æ•°: [20]          â”‚   â”‚
â”‚  â”‚ å¯ç”¨å·¥å…·è°ƒç”¨: [âœ“]               â”‚   â”‚
â”‚  â”‚ ç³»ç»Ÿæç¤ºè¯:                     â”‚   â”‚
â”‚  â”‚ [ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å­¦æœ¯è®ºæ–‡åˆ†æåŠ©æ‰‹] â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚
â”‚  [æ¸…é™¤æ‰€æœ‰å¯¹è¯å†å²]                     â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 "æµ‹è¯•è¿æ¥"åŠŸèƒ½

- å‘é€ä¸€ä¸ªç®€å•çš„ API è¯·æ±‚åˆ°é…ç½®çš„ URL
- æ˜¾ç¤ºè¿æ¥çŠ¶æ€ï¼ˆæˆåŠŸ/å¤±è´¥ï¼‰
- å¦‚æœå¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯

---

## 6. å¯¹è¯æµç¨‹ä¸ UI/UX ç»†èŠ‚

### 6.1 å¯¹è¯æ¡†çš„å®Œæ•´äº¤äº’æµç¨‹

```
ç”¨æˆ·é€‰ä¸­è®ºæ–‡
    â†“
ç‚¹å‡» AI Chat æ ‡ç­¾é¡µ
    â†“
åŠ è½½è¯¥è®ºæ–‡çš„å¯¹è¯å†å²ï¼ˆå¦‚æœæœ‰ï¼‰
    â†“
æ˜¾ç¤ºæ¶ˆæ¯åˆ—è¡¨
    â†“
ç”¨æˆ·è¾“å…¥é—®é¢˜
    â†“
ç‚¹å‡»å‘é€æŒ‰é’®
    â†“
æ˜¾ç¤º"æ­£åœ¨æ€è€ƒ..."åŠ è½½çŠ¶æ€
    â†“
æµå¼æ˜¾ç¤º AI å›å¤ï¼ˆMarkdown æ ¼å¼ï¼‰
    â†“
å¦‚æœå¯ç”¨å·¥å…·è°ƒç”¨ï¼ŒAI å¯èƒ½ä¼šè°ƒç”¨å·¥å…·
    â†“
å¯¹è¯å®Œæˆï¼Œè‡ªåŠ¨ä¿å­˜åˆ°æ•°æ®åº“
```

### 6.2 æ¶ˆæ¯å±•ç¤ºç»†èŠ‚

- **ç”¨æˆ·æ¶ˆæ¯**ï¼šå³å¯¹é½ï¼Œè“è‰²èƒŒæ™¯
- **AI æ¶ˆæ¯**ï¼šå·¦å¯¹é½ï¼Œç°è‰²èƒŒæ™¯ï¼Œæ”¯æŒ Markdown æ¸²æŸ“ï¼ˆåŠ ç²—ã€åˆ—è¡¨ã€ä»£ç å—ç­‰ï¼‰
- **å·¥å…·è°ƒç”¨**ï¼šæ˜¾ç¤ºä¸ºå¯æŠ˜å çš„å¡ç‰‡ï¼ˆ"ğŸ”§ è°ƒç”¨äº† get_paper_info"ï¼‰
- **åŠ è½½çŠ¶æ€**ï¼šæ˜¾ç¤ºåŠ¨ç”»åŠ è½½æŒ‡ç¤ºå™¨

### 6.3 åº•éƒ¨"+"é€‰é¡¹èœå•

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [ğŸ“‹ å¤åˆ¶æ¶ˆæ¯]               â”‚
â”‚ [ğŸ’¾ å¯¼å‡ºä¸º Markdown]        â”‚
â”‚ [ğŸ—‘ï¸ æ¸…é™¤å†å²]              â”‚
â”‚ [âš™ï¸ å·¥å…·è°ƒç”¨å¼€å…³]           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åŠŸèƒ½è¯´æ˜ï¼š**
- **å¤åˆ¶æ¶ˆæ¯**ï¼šå¤åˆ¶å•æ¡æ¶ˆæ¯åˆ°å‰ªè´´æ¿
- **å¯¼å‡ºä¸º Markdown**ï¼šå¯¼å‡ºå½“å‰è®ºæ–‡çš„æ‰€æœ‰å¯¹è¯ä¸º Markdown æ–‡ä»¶
- **æ¸…é™¤å†å²**ï¼šåˆ é™¤å½“å‰è®ºæ–‡çš„æ‰€æœ‰å¯¹è¯
- **å·¥å…·è°ƒç”¨å¼€å…³**ï¼šå¯ç”¨/ç¦ç”¨å·¥å…·è°ƒç”¨åŠŸèƒ½

---

## 7. é”™è¯¯å¤„ç†ä¸è¾¹ç•Œæƒ…å†µ

### 7.1 API é”™è¯¯å¤„ç†

| é”™è¯¯ç±»å‹ | å¤„ç†æ–¹å¼ |
|---------|---------|
| è¿æ¥å¤±è´¥ | æ˜¾ç¤º"æ— æ³•è¿æ¥åˆ° APIï¼Œè¯·æ£€æŸ¥è®¾ç½®" |
| è®¤è¯å¤±è´¥ | æ˜¾ç¤º"API Key æ— æ•ˆï¼Œè¯·æ£€æŸ¥è®¾ç½®" |
| é€Ÿç‡é™åˆ¶ | æ˜¾ç¤º"è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•" |
| è¶…æ—¶ | æ˜¾ç¤º"è¯·æ±‚è¶…æ—¶ï¼Œè¯·é‡è¯•" |

### 7.2 æ•°æ®è¾¹ç•Œæƒ…å†µ

| æƒ…å†µ | å¤„ç†æ–¹å¼ |
|------|---------|
| è®ºæ–‡æ²¡æœ‰æ‘˜è¦ | ä½¿ç”¨ Zotero.FullText è·å–å…¨æ–‡å†…å®¹ |
| å¯¹è¯å†å²è¶…è¿‡æœ€å¤§è½®æ•° | è‡ªåŠ¨åˆ é™¤æœ€æ—©çš„å¯¹è¯ |
| ç”¨æˆ·åˆ‡æ¢è®ºæ–‡ | ä¿å­˜å½“å‰è®ºæ–‡çš„å¯¹è¯ï¼ŒåŠ è½½æ–°è®ºæ–‡çš„å¯¹è¯ |
| å·¥å…·è°ƒç”¨å¤±è´¥ | æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼Œç»§ç»­å¯¹è¯ |

### 7.3 å®‰å…¨è€ƒè™‘

- API Key åŠ å¯†å­˜å‚¨åœ¨ Zotero æ•°æ®åº“ä¸­
- ä¸åœ¨æ—¥å¿—ä¸­è®°å½• API Key
- å·¥å…·è°ƒç”¨åªæš´éœ²å¿…è¦çš„ APIï¼ˆä¸å…è®¸åˆ é™¤æˆ–ä¿®æ”¹è®ºæ–‡ï¼‰

---

## 8. æŠ€æœ¯æ ˆ

| å±‚çº§ | æŠ€æœ¯ |
|------|------|
| **è¯­è¨€** | TypeScript |
| **æ¡†æ¶** | Zotero Plugin Toolkit |
| **UI** | HTML/CSS/JavaScript |
| **æ•°æ®åº“** | SQLite (Zotero) |
| **API è°ƒç”¨** | Fetch API |
| **Markdown æ¸²æŸ“** | marked.js æˆ–ç±»ä¼¼åº“ |

---

## 9. å¼€å‘é˜¶æ®µ

### Phase 1: MVPï¼ˆæœ€å°å¯è¡Œäº§å“ï¼‰
- [ ] åŸºç¡€ä¾§è¾¹æ  UI
- [ ] API é…ç½®å’Œæµ‹è¯•è¿æ¥
- [ ] åŸºç¡€å¯¹è¯åŠŸèƒ½ï¼ˆæ— æµå¼è¾“å‡ºï¼‰
- [ ] å¯¹è¯å†å²ä¿å­˜

### Phase 2: å¢å¼ºåŠŸèƒ½
- [ ] æµå¼è¾“å‡ºæ”¯æŒ
- [ ] Markdown æ¸²æŸ“
- [ ] å·¥å…·è°ƒç”¨æ¡†æ¶

### Phase 3: å®Œæ•´åŠŸèƒ½
- [ ] å¯¹è¯ç®¡ç†ï¼ˆæ¸…é™¤ã€å¯¼å‡ºã€å¤åˆ¶ï¼‰
- [ ] é«˜çº§è®¾ç½®ï¼ˆç³»ç»Ÿæç¤ºè¯ã€æ¸©åº¦ç­‰ï¼‰
- [ ] UI ä¼˜åŒ–å’Œä¸»é¢˜æ”¯æŒ

---

## 10. æˆåŠŸæ ‡å‡†

- âœ… ç”¨æˆ·å¯ä»¥åœ¨ä¾§è¾¹æ ä¸ AI å¯¹è¯
- âœ… å¯¹è¯å†å²æŒ‰æ–‡çŒ®ä¿å­˜
- âœ… æ”¯æŒ OpenAI å…¼å®¹çš„ API
- âœ… å·¥å…·è°ƒç”¨åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- âœ… UI ç¾è§‚ç®€æ´ï¼Œä¸æ‰“æ‰°é˜…è¯»
- âœ… æ‰€æœ‰é¢å¤–åŠŸèƒ½ï¼ˆæ¸…é™¤ã€å¯¼å‡ºã€å¤åˆ¶ï¼‰æ­£å¸¸å·¥ä½œ

---

## 11. æ–‡ä»¶ç»“æ„è®¾è®¡

### 11.1 é¡¹ç›®æ–‡ä»¶ç»„ç»‡

```
src/
â”œâ”€â”€ index.ts                          # æ’ä»¶å…¥å£
â”œâ”€â”€ addon.ts                          # Addon ç±»å®šä¹‰
â”œâ”€â”€ hooks.ts                          # ç”Ÿå‘½å‘¨æœŸé’©å­
â”œâ”€â”€ modules/
â”‚   â”œâ”€â”€ chatPanel.ts                  # ä¾§è¾¹æ ä¸»ç»„ä»¶
â”‚   â”œâ”€â”€ apiClient.ts                  # OpenAI API å®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ toolCaller.ts                 # å·¥å…·è°ƒç”¨æ‰§è¡Œå™¨
â”‚   â”œâ”€â”€ storageManager.ts             # æ•°æ®åº“æ“ä½œ
â”‚   â”œâ”€â”€ settingsManager.ts            # è®¾ç½®ç®¡ç†
â”‚   â””â”€â”€ zoteroAPI.ts                  # Zotero API å°è£…
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ markdown.ts                   # Markdown æ¸²æŸ“
â”‚   â”œâ”€â”€ crypto.ts                     # API Key åŠ å¯†
â”‚   â”œâ”€â”€ logger.ts                     # æ—¥å¿—å·¥å…·
â”‚   â””â”€â”€ constants.ts                  # å¸¸é‡å®šä¹‰
â””â”€â”€ types/
    â””â”€â”€ index.ts                      # TypeScript ç±»å‹å®šä¹‰

addon/
â”œâ”€â”€ content/
â”‚   â”œâ”€â”€ chatPanel.html                # ä¾§è¾¹æ  HTML
â”‚   â”œâ”€â”€ chatPanel.css                 # ä¾§è¾¹æ æ ·å¼
â”‚   â”œâ”€â”€ preferences.xhtml             # è®¾ç½®é¡µé¢
â”‚   â””â”€â”€ icons/
â””â”€â”€ locale/
    â”œâ”€â”€ en-US/
    â”‚   â”œâ”€â”€ addon.ftl
    â”‚   â”œâ”€â”€ mainWindow.ftl
    â”‚   â””â”€â”€ preferences.ftl
    â””â”€â”€ zh-CN/
        â”œâ”€â”€ addon.ftl
        â”œâ”€â”€ mainWindow.ftl
        â””â”€â”€ preferences.ftl
```

---

## 12. API å®¢æˆ·ç«¯å®ç°æ–¹æ¡ˆ

### 12.1 OpenAI å…¼å®¹ API è°ƒç”¨

```typescript
// src/modules/apiClient.ts
interface APIConfig {
  url: string;
  apiKey: string;
  model: string;
  temperature?: number;
  maxTokens?: number;
}

interface Message {
  role: 'user' | 'assistant' | 'system';
  content: string;
}

class APIClient {
  private config: APIConfig;

  async chat(messages: Message[], onChunk?: (chunk: string) => void): Promise<string> {
    const response = await fetch(`${this.config.url}/chat/completions`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${this.config.apiKey}`,
      },
      body: JSON.stringify({
        model: this.config.model,
        messages,
        temperature: this.config.temperature ?? 0.7,
        max_tokens: this.config.maxTokens ?? 2000,
        stream: true,
      }),
    });

    if (!response.ok) {
      throw new Error(`API Error: ${response.status}`);
    }

    return this.handleStream(response, onChunk);
  }

  private async handleStream(response: Response, onChunk?: (chunk: string) => void): Promise<string> {
    const reader = response.body?.getReader();
    if (!reader) throw new Error('No response body');

    let fullText = '';
    const decoder = new TextDecoder();

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      const chunk = decoder.decode(value);
      const lines = chunk.split('\n');

      for (const line of lines) {
        if (line.startsWith('data: ')) {
          const data = line.slice(6);
          if (data === '[DONE]') continue;

          try {
            const json = JSON.parse(data);
            const content = json.choices?.[0]?.delta?.content || '';
            if (content) {
              fullText += content;
              onChunk?.(content);
            }
          } catch (e) {
            // å¿½ç•¥è§£æé”™è¯¯
          }
        }
      }
    }

    return fullText;
  }

  async testConnection(): Promise<boolean> {
    try {
      const response = await fetch(`${this.config.url}/models`, {
        headers: {
          'Authorization': `Bearer ${this.config.apiKey}`,
        },
      });
      return response.ok;
    } catch {
      return false;
    }
  }
}
```

---

## 13. Zotero API è°ƒç”¨æ–¹å¼

### 13.1 è·å–è®ºæ–‡å†…å®¹

```typescript
// src/modules/zoteroAPI.ts
class ZoteroAPI {
  // è·å–è®ºæ–‡åŸºæœ¬ä¿¡æ¯
  static getPaperInfo(itemID: number) {
    const item = Zotero.Items.get(itemID);
    return {
      title: item.getField('title'),
      authors: item.getCreators(),
      abstract: item.getField('abstractNote'),
      year: item.getField('date'),
      tags: item.getTags(),
    };
  }

  // è·å–è®ºæ–‡å…¨æ–‡å†…å®¹
  static async getPaperContent(itemID: number): Promise<string> {
    try {
      const text = await Zotero.FullText.getItemText(itemID);
      return text || 'æ— æ³•è·å–æ–‡çŒ®å†…å®¹ï¼Œè¯·ç¡®ä¿ PDF å·²è¢«ç´¢å¼•';
    } catch (error) {
      return `è·å–å†…å®¹å¤±è´¥: ${error}`;
    }
  }

  // æœç´¢è®ºæ–‡
  static searchPapers(query: string, limit: number = 10) {
    const search = new Zotero.Search();
    search.addCondition('title', 'contains', query);
    const results = search.search();
    return results.slice(0, limit).map(id => this.getPaperInfo(id));
  }

  // è·å–å½“å‰é€‰ä¸­çš„è®ºæ–‡
  static getSelectedItem() {
    const pane = Zotero.getActiveZoteroPane();
    const items = pane.getSelectedItems();
    return items.length > 0 ? items[0] : null;
  }
}
```

---

## 14. UI ç»„ä»¶ CSS è®¾è®¡

### 14.1 ä¾§è¾¹æ æ ·å¼

```css
/* addon/content/chatPanel.css */

.marginalia-container {
  display: flex;
  flex-direction: column;
  height: 100%;
  background: #ffffff;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

.marginalia-messages {
  flex: 1;
  overflow-y: auto;
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.marginalia-message {
  display: flex;
  gap: 8px;
  margin-bottom: 8px;
}

.marginalia-message.user {
  justify-content: flex-end;
}

.marginalia-message.assistant {
  justify-content: flex-start;
}

.marginalia-message-content {
  max-width: 85%;
  padding: 10px 12px;
  border-radius: 8px;
  word-wrap: break-word;
  line-height: 1.5;
}

.marginalia-message.user .marginalia-message-content {
  background: #007AFF;
  color: white;
}

.marginalia-message.assistant .marginalia-message-content {
  background: #E5E5EA;
  color: #000;
}

.marginalia-input-area {
  padding: 12px;
  border-top: 1px solid #E5E5EA;
  display: flex;
  gap: 8px;
}

.marginalia-input {
  flex: 1;
  padding: 8px 12px;
  border: 1px solid #D1D1D6;
  border-radius: 6px;
  font-size: 14px;
  resize: none;
  max-height: 100px;
}

.marginalia-button {
  padding: 8px 16px;
  background: #007AFF;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
}

.marginalia-button:hover {
  background: #0051D5;
}

.marginalia-button:disabled {
  background: #D1D1D6;
  cursor: not-allowed;
}

.marginalia-loading {
  display: flex;
  align-items: center;
  gap: 8px;
  color: #999;
  font-size: 13px;
}

.marginalia-spinner {
  width: 16px;
  height: 16px;
  border: 2px solid #E5E5EA;
  border-top-color: #007AFF;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.marginalia-tool-call {
  background: #F5F5F5;
  border-left: 3px solid #007AFF;
  padding: 8px 12px;
  border-radius: 4px;
  font-size: 13px;
  margin: 4px 0;
}

.marginalia-options-menu {
  position: absolute;
  background: white;
  border: 1px solid #D1D1D6;
  border-radius: 6px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  z-index: 1000;
}

.marginalia-options-menu button {
  display: block;
  width: 100%;
  padding: 8px 12px;
  border: none;
  background: none;
  text-align: left;
  cursor: pointer;
  font-size: 13px;
}

.marginalia-options-menu button:hover {
  background: #F5F5F5;
}
```

---

## 15. æµ‹è¯•ç­–ç•¥

### 15.1 å•å…ƒæµ‹è¯•

```typescript
// test/apiClient.test.ts
describe('APIClient', () => {
  it('should handle streaming responses', async () => {
    // Mock fetch
    // Test stream parsing
  });

  it('should handle API errors', async () => {
    // Test error handling
  });

  it('should test connection', async () => {
    // Test connection validation
  });
});
```

### 15.2 é›†æˆæµ‹è¯•

- æµ‹è¯•ä¾§è¾¹æ  UI åŠ è½½
- æµ‹è¯•å¯¹è¯ä¿å­˜å’ŒåŠ è½½
- æµ‹è¯•å·¥å…·è°ƒç”¨åŠŸèƒ½
- æµ‹è¯•è®¾ç½®é¡µé¢ä¿å­˜

### 15.3 æ‰‹åŠ¨æµ‹è¯•æ¸…å•

- [ ] ä¾§è¾¹æ æ­£å¸¸æ˜¾ç¤º
- [ ] å¯ä»¥å‘é€æ¶ˆæ¯å¹¶æ”¶åˆ°å›å¤
- [ ] æµå¼è¾“å‡ºæ­£å¸¸æ˜¾ç¤º
- [ ] å¯¹è¯å†å²æ­£ç¡®ä¿å­˜
- [ ] å·¥å…·è°ƒç”¨åŠŸèƒ½æ­£å¸¸
- [ ] è®¾ç½®é¡µé¢å¯ä»¥ä¿å­˜é…ç½®
- [ ] API è¿æ¥æµ‹è¯•åŠŸèƒ½æ­£å¸¸

---

## 16. éƒ¨ç½²å’Œå‘å¸ƒæµç¨‹

### 16.1 æ„å»ºæµç¨‹

```bash
# å¼€å‘æ¨¡å¼
npm run start

# æ„å»ºç”Ÿäº§ç‰ˆæœ¬
npm run build

# å‘å¸ƒ
npm run release
```

### 16.2 ç‰ˆæœ¬ç®¡ç†

- éµå¾ª Semantic Versioning (SemVer)
- åœ¨ `package.json` ä¸­æ›´æ–°ç‰ˆæœ¬å·
- åœ¨ `addon/manifest.json` ä¸­æ›´æ–°ç‰ˆæœ¬å·

### 16.3 å‘å¸ƒæ£€æŸ¥æ¸…å•

- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] ä»£ç å®¡æŸ¥å®Œæˆ
- [ ] æ–‡æ¡£å·²æ›´æ–°
- [ ] ç‰ˆæœ¬å·å·²æ›´æ–°
- [ ] CHANGELOG å·²æ›´æ–°
- [ ] æ„å»ºæˆåŠŸ
- [ ] å‘å¸ƒåˆ° Zotero æ’ä»¶å¸‚åœº

---

## 17. åç»­ä¼˜åŒ–æ–¹å‘

- æ”¯æŒæ›´å¤š LLM æä¾›å•†ï¼ˆClaudeã€Gemini ç­‰ï¼‰
- å¯¹è¯æœç´¢åŠŸèƒ½
- å¯¹è¯åˆ†æ”¯ç®¡ç†
- è‡ªå®šä¹‰å¿«æ·é”®
- ä¸»é¢˜å’Œå¤–è§‚å®šåˆ¶
- ç¦»çº¿æ¨¡å¼æ”¯æŒ
- å¯¹è¯å¯¼å…¥/å¯¼å‡ºåŠŸèƒ½
- æ‰¹é‡å¤„ç†å¤šç¯‡è®ºæ–‡
