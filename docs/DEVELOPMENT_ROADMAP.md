# Marginalia AI Chat - 开发路线图

**项目**: Marginalia AI Chat Plugin for Zotero 7
**开始日期**: 2026-02-15
**目标完成日期**: 2026-03-15

---

## Phase 1: MVP（最小可行产品）- 第 1-2 周

### 1.1 基础架构搭建
- [ ] 初始化 Zotero 插件项目结构
- [ ] 配置 TypeScript 和构建工具
- [ ] 创建基础的 Addon 类和生命周期钩子
- [ ] 注册侧边栏 Tab（AI Chat）

### 1.2 数据库和存储
- [ ] 创建 SQLite 表（marginalia_conversations, marginalia_settings）
- [ ] 实现 StorageManager 类
  - [ ] 保存对话历史
  - [ ] 加载对话历史
  - [ ] 删除对话历史
- [ ] 实现 SettingsManager 类
  - [ ] 保存设置（API URL, API Key, Model）
  - [ ] 加载设置
  - [ ] API Key 加密存储

### 1.3 基础 UI
- [ ] 创建侧边栏 HTML 结构（chatPanel.html）
- [ ] 编写基础 CSS 样式（chatPanel.css）
- [ ] 实现消息列表展示
- [ ] 实现输入框和发送按钮
- [ ] 实现加载状态指示器

### 1.4 API 集成（无流式输出）
- [ ] 实现 APIClient 类
  - [ ] 基础 API 请求（非流式）
  - [ ] 错误处理
  - [ ] 超时处理
- [ ] 实现设置页面（preferences.xhtml）
  - [ ] API URL 输入框
  - [ ] API Key 输入框
  - [ ] Model 选择框
  - [ ] 保存按钮

### 1.5 基础对话功能
- [ ] 用户输入消息
- [ ] 调用 API 获取回复
- [ ] 显示 AI 回复
- [ ] 保存对话到数据库
- [ ] 切换论文时加载对应的对话历史

**验收标准**:
- ✅ 侧边栏能正常显示
- ✅ 可以输入消息并获得 AI 回复
- ✅ 对话历史能正确保存和加载
- ✅ 设置页面能保存 API 配置

---

## Phase 2: 增强功能 - 第 3-4 周

### 2.1 流式输出支持
- [ ] 修改 APIClient 支持流式响应
- [ ] 实现流式文本逐字显示
- [ ] 优化 UI 响应性能

### 2.2 Markdown 渲染
- [ ] 集成 marked.js 库
- [ ] 实现 Markdown 渲染器
- [ ] 支持代码块、列表、加粗等格式
- [ ] 处理代码块的语法高亮

### 2.3 API 连接测试
- [ ] 实现"测试连接"功能
- [ ] 显示连接状态（成功/失败）
- [ ] 显示错误信息

### 2.4 Zotero API 集成
- [ ] 实现 ZoteroAPI 类
  - [ ] getPaperInfo() - 获取论文基本信息
  - [ ] getPaperContent() - 获取论文全文
  - [ ] searchPapers() - 搜索论文
  - [ ] getSelectedItem() - 获取当前选中论文

### 2.5 系统提示词支持
- [ ] 在设置页面添加系统提示词输入框
- [ ] 在 API 请求中使用系统提示词
- [ ] 支持自定义系统提示词

**验收标准**:
- ✅ 流式输出正常显示
- ✅ Markdown 格式正确渲染
- ✅ 测试连接功能正常工作
- ✅ 可以获取论文信息

---

## Phase 3: 工具调用功能 - 第 5 周

### 3.1 工具调用框架
- [x] 定义工具接口
- [x] 实现 ToolCaller 类
  - [x] 解析 AI 的工具调用请求
  - [x] 执行相应的工具
  - [x] 返回工具执行结果

### 3.2 可用工具实现
- [x] get_paper_info - 获取论文信息
- [x] get_paper_content - 获取论文内容
- [x] search_papers - 搜索论文

### 3.3 工具调用 UI
- [x] 显示工具调用过程（可折叠卡片）
- [x] 显示工具调用结果
- [x] 在设置页面添加"启用工具调用"开关

### 3.4 对话历史中的工具调用记录
- [x] 保存工具调用信息到数据库
- [x] 加载时恢复工具调用信息

**验收标准**:
- ✅ AI 可以调用工具
- ✅ 工具调用结果正确显示
- ✅ 工具调用信息正确保存

---

## Phase 4: 对话管理功能 - 第 6 周

### 4.1 底部选项菜单
- [x] 实现"+"按钮和下拉菜单
- [x] 菜单项：复制消息、导出为 Markdown、清除历史、工具调用开关

### 4.2 复制消息功能
- [x] 实现单条消息复制
- [x] 支持复制 Markdown 格式

### 4.3 导出为 Markdown
- [x] 实现对话导出功能
- [x] 生成格式化的 Markdown 文件
- [x] 支持下载或保存到文件

### 4.4 清除历史
- [x] 实现清除当前论文的对话历史
- [x] 添加确认对话框

### 4.5 对话轮数限制
- [x] 实现自动删除超过最大轮数的旧对话
- [x] 在设置页面配置最大保存轮数

**验收标准**:
- ✅ 所有菜单功能正常工作
- ✅ 导出的 Markdown 格式正确
- ✅ 对话历史正确清除

---

## Phase 5: UI 优化和测试 - 第 7 周

### 5.1 UI/UX 优化
- [ ] 优化消息列表滚动体验
- [ ] 优化输入框高度自适应
- [ ] 优化加载状态动画
- [ ] 优化错误提示显示

### 5.2 响应式设计
- [ ] 测试不同窗口大小下的显示
- [ ] 优化移动端显示（如果适用）

### 5.3 国际化
- [ ] 添加中文本地化字符串
- [ ] 添加英文本地化字符串
- [ ] 在设置页面支持语言切换

### 5.4 单元测试
- [ ] 编写 APIClient 测试
- [ ] 编写 StorageManager 测试
- [ ] 编写 ToolCaller 测试

### 5.5 集成测试
- [ ] 测试完整的对话流程
- [ ] 测试工具调用流程
- [ ] 测试设置保存和加载

**验收标准**:
- ✅ UI 美观简洁
- ✅ 所有测试通过
- ✅ 支持多语言

---

## Phase 6: 文档和发布 - 第 8 周

### 6.1 文档编写
- [ ] 编写用户使用指南
- [ ] 编写开发者文档
- [ ] 编写 API 文档
- [ ] 编写故障排除指南

### 6.2 代码审查
- [ ] 代码风格检查
- [ ] 性能审查
- [ ] 安全审查

### 6.3 构建和打包
- [ ] 构建生产版本
- [ ] 生成插件包文件

### 6.4 发布
- [ ] 发布到 Zotero 插件市场
- [ ] 创建 GitHub Release
- [ ] 编写 CHANGELOG

**验收标准**:
- ✅ 文档完整
- ✅ 代码审查通过
- ✅ 插件成功发布

---

## 关键里程碑

| 日期 | 里程碑 | 状态 |
|------|--------|------|
| 2026-02-22 | Phase 1 完成 - MVP 可用 | ⏳ |
| 2026-03-01 | Phase 2 完成 - 增强功能 | ⏳ |
| 2026-03-08 | Phase 3 完成 - 工具调用 | ✅ |
| 2026-03-15 | Phase 4 完成 - 对话管理 | ✅ |
| 2026-03-22 | Phase 5-6 完成 - 发布 | ⏳ |

---

## 风险和缓解措施

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| Zotero API 变化 | 功能不可用 | 定期检查 Zotero 文档 |
| 流式输出性能问题 | UI 卡顿 | 优化渲染逻辑 |
| 数据库锁定 | 对话保存失败 | 实现重试机制 |
| API 速率限制 | 用户体验差 | 添加速率限制提示 |

---

## 依赖和资源

### 外部依赖
- zotero-plugin-toolkit ^5.1.0
- marked.js (Markdown 渲染)
- 可选：highlight.js (代码高亮)

### 开发工具
- TypeScript 5.9+
- Node.js 18+
- npm 9+

### 参考资源
- [Zotero Plugin Development Guide](https://www.zotero.org/support/dev/client_coding/plugin_development)
- [OpenAI API Documentation](https://platform.openai.com/docs)
- [Zotero Plugin Toolkit](https://github.com/windingwind/zotero-plugin-toolkit)

---

## 更新日志

### 2026-02-15
- 创建初始开发路线图
- 定义 6 个开发阶段
- 设定 8 周完成目标
